#!/data/data/com.termux/files/usr/bin/bash

G='\e[32m'
B='\e[34m'
Y='\e[33m'
R='\e[31m'
N='\e[0m'

VER_FILE="$HOME/.fntm/version_txt"
RAW_GO_URL="https://raw.githubusercontent.com/itoryon/meow/main/main.go"
mkdir -p ~/.fntm

echo -e "${G}[*] Проверка обновлений Meow GUI (Golang)...${N}"

# 1. Проверка системных пакетов
if ! command -v go &> /dev/null; then
    echo -e "${B}[*] Установка Golang и графических библиотек...${N}"
    pkg update -y
    pkg install -y golang termux-api pkg-config x11-repo libx11 libxcursor libxinerama libxrandr libxi mesa
fi

# 2. Локальная версия
[ -f "$VER_FILE" ] && LOCAL_VER=$(cat "$VER_FILE") || LOCAL_VER="0.0"

# 3. Запрос версии с GitHub
echo -e "${B}[*] Запрос версии с GitHub...${N}"
RAW_CONTENT=$(curl -sL "$RAW_GO_URL" | head -n 50)
REMOTE_VER=$(echo "$RAW_CONTENT" | grep -E "VERSION\s*=" | cut -d'"' -f2 | head -n 1)

[ -z "$REMOTE_VER" ] && REMOTE_VER="5.0_gui" # Заглушка, если в коде нет строки VERSION

DO_INSTALL=false
if [ "$LOCAL_VER" == "$REMOTE_VER" ] && [ -f ~/meoww_gui ]; then
    echo -e "${G}[+] Версия $LOCAL_VER актуальна.${N}"
    read -p "Переустановить? (y/N): " reconf
    [[ $reconf =~ ^[Yy]$ ]] && DO_INSTALL=true
else
    echo -e "${Y}[!] Доступно обновление: $LOCAL_VER -> $REMOTE_VER${N}"
    read -p "Установить? (Y/n): " conf
    [[ ! $conf =~ ^[Nn]$ ]] && DO_INSTALL=true
fi

# 4. Сборка
if [ "$DO_INSTALL" = true ]; then
    echo -e "${B}[*] Загрузка кода и модулей...${N}"
    curl -L "$RAW_GO_URL" -o "main.go"
    
    # Инициализация модуля Go, если нужно
    [ ! -f "go.mod" ] && go mod init meow_chat
    go get fyne.io/fyne/v2

    echo -e "${B}[*] Сборка бинарного файла (это может занять минуту)...${N}"
    # Собираем с флагами оптимизации
    if go build -ldflags="-s -w" -o ~/meoww_gui main.go; then
        echo "$REMOTE_VER" > "$VER_FILE"
        echo -e "${G}[OK] Успешно установлено в ~/meoww_gui${N}"
        
        # Разрешаем запуск внешних приложений (для уведомлений)
        mkdir -p ~/.termux
        echo "allow-external-apps=true" >> ~/.termux/termux.properties
        termux-reload-settings

        rm main.go
    else
        echo -e "${R}[-] Ошибка сборки! Проверьте зависимости.${N}"
        exit 1
    fi
else
    echo -e "${B}[*] Отмена.${N}"
fi
